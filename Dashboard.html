<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î - ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --header-gradient: linear-gradient(90deg, #00d2ff 0%, #3a47d5 100%);
            --primary-color: #3a47d5;
            --secondary-color: #f4f7fc;
            --text-color: #333;
            --light-text-color: #777;
            --white-color: #ffffff;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding-top: 80px; /* Space for fixed header */
        }

        /* --- Header & Navigation --- */
        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--white-color);
            box-shadow: var(--box-shadow);
            padding: 0 2rem;
            height: 80px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }
        .logo-container img { width: 50px; }
        .logo-container span { font-weight: 600; font-size: 1.2rem; margin-left: 1rem; }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-menu a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-menu a:hover, .nav-menu a.active { color: var(--primary-color); }
        
        .admin-menu { display: none; } /* Hidden by default */

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .user-profile #welcome-message { font-size: 0.9rem; }
        .btn-logout {
            background-color: var(--danger-color);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Prompt', sans-serif;
        }
        
        /* --- Main Content --- */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .dashboard-header h1 { font-size: 2rem; }
        .btn-new-submission {
            background: var(--header-gradient);
            color: white;
            padding: 12px 25px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 1rem;
        }

        /* --- Filter Section --- */
        .filter-container {
            background: var(--white-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .filter-group { flex: 1; min-width: 180px; }
        .filter-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Prompt', sans-serif;
        }

        /* --- Data Display --- */
        #dashboard-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: var(--light-text-color);
        }
        
        .plan-card {
            background: var(--white-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .plan-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #eee; }
        .card-header h3 { margin: 0; font-size: 1.1rem; }
        .card-header p { margin: 0.25rem 0 0; font-size: 0.9rem; color: var(--light-text-color); }
        
        .card-body { padding: 1.5rem; flex-grow: 1; }
        .card-detail { display: flex; justify-content: space-between; margin-bottom: 0.75rem; font-size: 0.9rem; }
        .card-detail span:first-child { font-weight: 500; }
        .card-detail a { color: var(--primary-color); text-decoration: none; }
        
        .card-footer {
            background-color: #fdfdfd;
            padding: 1rem 1.5rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.8rem;
            color: white;
        }
        .status-badge.pending { background-color: var(--warning-color); }
        .status-badge.approved { background-color: var(--success-color); }
        .status-badge.revision { background-color: var(--danger-color); }

        .action-buttons button {
            background: none;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Prompt', sans-serif;
        }
        .action-buttons button:hover { background: var(--primary-color); color: white; }

        footer {
            text-align: center;
            padding: 2rem;
            margin-top: 2rem;
            color: var(--light-text-color);
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo-container">
            <img src="https://img5.pic.in.th/file/secure-sv1/-sena-bg.png" alt="Logo">
            <span>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</span>
        </div>
        <nav class="nav-menu">
            <a href="#" id="nav-submission" class="nav-link">üìù ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</a>
            <a href="#" id="nav-dashboard" class="nav-link">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a>
            <a href="#" id="nav-profile" class="nav-link">üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
            <a href="#" id="nav-admin-users" class="nav-link admin-menu">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a>
            <a href="#" id="nav-admin-log" class="nav-link admin-menu">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Log</a>
        </nav>
        <div class="user-profile">
            <span id="welcome-message"></span>
            <button id="logoutButton" class="btn-logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </header>
    
    <div class="container">
        <div class="dashboard-header">
            <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h1>
            <a href="#" id="newSubmissionButton" class="btn-new-submission">‚ûï ‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</a>
        </div>

        <div class="filter-container">
            </div>

        <div id="dashboard-content">
            <div class="loading-spinner">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>
    </div>
    
    <footer>
        <p>‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ Mr.Boonchai Boonsopon ¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
    </footer>


    <script>
        // --- GLOBAL VARIABLES ---
        const WEB_APP_URL = '<?= ScriptApp.getService().getUrl() ?>';
        let loggedInUser = null;
        let allPlansData = []; // To store all fetched data for client-side filtering

        // --- ON PAGE LOAD ---
        window.addEventListener('DOMContentLoaded', () => {
            authenticateUser();
            setupUI();
            fetchDashboardData();
        });

        /**
         * Checks if user is logged in via sessionStorage. Redirects if not.
         */
        function authenticateUser() {
            const userData = sessionStorage.getItem('loggedInUser');
            if (!userData) {
                window.location.href = WEB_APP_URL + '?page=Index';
                return;
            }
            loggedInUser = JSON.parse(userData);
        }

        /**
         * Sets up the static parts of the UI based on user role.
         */
function setupUI() {
            // Welcome message
            document.getElementById('welcome-message').textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ‡∏Ñ‡∏∏‡∏ì ${loggedInUser.fullName}`;

            // Show/Hide Admin Menus
            const isAdmin = ['Admin', '‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£', '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤'].includes(loggedInUser.position);
            if (isAdmin) {
                document.querySelectorAll('.admin-menu').forEach(el => el.style.display = 'inline-block');
            }

            // Setup Logout Button
            document.getElementById('logoutButton').addEventListener('click', logout);
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
            // ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠ 'Dashboard' ‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
            setupNavigation('Dashboard');
        }

        /**
         * Fetches all relevant plan data from the server.
         */
        function fetchDashboardData() {
            const contentDiv = document.getElementById('dashboard-content');
            contentDiv.innerHTML = '<div class="loading-spinner">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';

            google.script.run
                .withSuccessHandler(response => {
                    allPlansData = response;
                    renderDashboard(allPlansData);
                })
                .withFailureHandler(onFailure)
                .getDashboardData(loggedInUser.username, loggedInUser.position);
        }

        /**
         * Renders the plan cards on the dashboard.
         * @param {Array<object>} plansData The array of plan objects to render.
         */
        function renderDashboard(plansData) {
            const contentDiv = document.getElementById('dashboard-content');
            contentDiv.innerHTML = ''; // Clear previous content

            if (plansData.length === 0) {
                contentDiv.innerHTML = '<div class="loading-spinner">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
                return;
            }
            
            plansData.forEach(plan => {
                const card = createPlanCard(plan);
                contentDiv.appendChild(card);
            });
        }
        
        /**
         * Creates a single plan card element.
         * @param {object} plan The plan data object.
         * @returns {HTMLElement} The card element.
         */
        function createPlanCard(plan) {
            const card = document.createElement('div');
            card.className = 'plan-card';
            
            const submissionDate = new Date(plan['‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á']).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // Determine overall status
            let overallStatus, statusText, statusClass;
            const finalStatus = plan['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Ø)'];
            const deputyStatus = plan['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Ø)'];
            const academicStatus = plan['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£)'];

            if (academicStatus === '‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' || deputyStatus === '‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' || finalStatus === '‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç') {
                overallStatus = 'revision';
                statusText = '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚ùó';
                statusClass = 'revision';
            } else if (finalStatus === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß') {
                overallStatus = 'approved';
                statusText = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
                statusClass = 'approved';
            } else {
                overallStatus = 'pending';
                statusText = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‚≠ê';
                statusClass = 'pending';
            }
            
            card.innerHTML = `
                <div class="card-header">
                    <h3>${plan['‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤']} (${plan['‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤']})</h3>
                    <p>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á: ${plan['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}</p>
                </div>
                <div class="card-body">
                    <div class="card-detail"><span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á:</span> <span>${submissionDate}</span></div>
                    <div class="card-detail"><span>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</span> <span>${plan['‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤']}</span></div>
                    <div class="card-detail"><span>‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span> <span>${plan['‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']}</span></div>
                    <div class="card-detail"><span>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤:</span> <a href="${plan['‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö 1 (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤)']}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå PDF</a></div>
                    <div class="card-detail"><span>‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</span> <a href="${plan['‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö 2 (‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ)']}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå PDF</a></div>
                </div>
                <div class="card-footer">
                    <span class="status-badge ${statusClass}">${statusText}</span>
                    <div class="action-buttons" id="actions-${plan.rowId}"></div>
                </div>
            `;
            
            // --- Add Action Buttons based on Role and Status ---
            const actionContainer = card.querySelector(`#actions-${plan.rowId}`);
            
            // Teachers can edit if revision is requested
            if (loggedInUser.fullName === plan['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] && overallStatus === 'revision') {
                const editButton = document.createElement('button');
                editButton.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà';
                editButton.onclick = () => showResubmitModal(plan);
                actionContainer.appendChild(editButton);
            }

            // Approvers can approve/reject if it's their turn
            const approverRoles = {
                '‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£': academicStatus,
                '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤': deputyStatus,
                '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤': finalStatus
            };
            const isPreviousApproved = (role) => {
                if (role === '‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£') return true; // First in line
                if (role === '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤') return academicStatus === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
                if (role === '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤') return deputyStatus === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
                return false;
            }

            if (approverRoles[loggedInUser.position] === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' && isPreviousApproved(loggedInUser.position)) {
                 const approveButton = document.createElement('button');
                 approveButton.textContent = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                 approveButton.onclick = () => showApprovalModal(plan);
                 actionContainer.appendChild(approveButton);
            }
            
            return card;
        }

        // --- ACTION HANDLERS & MODALS ---

        function showApprovalModal(plan) {
            // This function would show a modal for approval
            Swal.fire({
                title: `‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô: ${plan['‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤']}`,
                html: `
                    <p><b>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á:</b> ${plan['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}</p>
                    <p>‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</p>
                    <textarea id="approvalComment" class="swal2-textarea" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                `,
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                denyButtonText: '‚ùó ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed || result.isDenied) {
                    const comment = document.getElementById('approvalComment').value;
                    const decision = result.isConfirmed ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';

                    if (result.isDenied && !comment) {
                         Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error');
                         return;
                    }
                    
                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                    google.script.run
                        .withSuccessHandler(() => {
                            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                            fetchDashboardData(); // Refresh data
                        })
                        .withFailureHandler(onFailure)
                        .processApproval(plan.rowId, loggedInUser.position, decision, comment, loggedInUser.username);
                }
            });
        }
        
        function showResubmitModal(plan) {
            // This function would show a modal for resubmitting
            // A more complex implementation might be needed, but this is a start
            Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏≥‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà', 'info');
            // For now, let's just show an alert. A full implementation would redirect to a pre-filled form.
        }

        function logout() {
            sessionStorage.removeItem('loggedInUser');
            window.location.href = WEB_APP_URL + '?page=Index';
        }

        function onFailure(error) {
            Swal.fire({
                icon: 'error',
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á',
                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ: ' + error.message
            });
        }

/**
 * Sets up navigation links and highlights the active page.
 * @param {string} activePage - The name of the current page ('Dashboard', 'SubmissionForm', etc.)
 */
function setupNavigation(activePage) {
    const navLinks = {
        'SubmissionForm': document.getElementById('nav-submission'),
        'Dashboard': document.getElementById('nav-dashboard'),
        'Profile': document.getElementById('nav-profile'),
        'Admin': document.getElementById('nav-admin-users'),
        'AdminLog': document.getElementById('nav-admin-log')
    };

    // Add click event listeners to all links
    for (const [page, element] of Object.entries(navLinks)) {
        if (element) {
            // Highlight the active page link
            if (page === activePage) {
                element.classList.add('active');
            } else {
                element.classList.remove('active');
            }

            // Set up the click action to navigate
            element.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = `${WEB_APP_URL}?page=${page}`;
            });
        }
    }
}

    </script>
</body>
</html>
